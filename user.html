const nodemailer = require('nodemailer'); 
const crypto=require('crypto')
const env=require('dotenv').config(); 
const bcrypt = require('bcrypt'); 
const moment = require('moment-timezone');
const validator = require('validator');
const User = require('../../models/userModel'); 
const category=require('../../models/categoryModel')
const product=require('../../models/productModel');
const OTP=require('../../models/otpModel')
const { name } = require('ejs');
const Cart=require('../../models/cartModel')
const Wishlist=require('../../models/wishlistModel')
const Offer=require('../../models/offerModel')
const PDFDocument = require('pdfkit');
const fs = require('fs');
const Order = require('../../models/orderModel');
const path = require('path');
const wallet = require('../../models/walletModel');
const { addReferralBonusToWallet } = require('../user/walletController');




const loadIndexPage = async(req, res) => {
    try {
        if(req.session.email){
            res.redirect("/userHomePage")
        }else{
            const Category = await category.find({ isDeleted: false });
            const Product = await product.find({ isDelete: false });
            res.render('user/index',{Category,Product})
        }
    } catch (error) {
        console.error('Error during login:', error);
        return res.status(500).json({ error: 'Something went wrong. Please try again.' });  
    }
    
};

const loadLogin = (req, res) => {
    if(req.session.email){
        res.redirect("/userHomePage")
    }else {
        res.render('user/loginPage');
    }
};

const login = async (req, res) => {
    try {
        const { email, password } = req.body;
        const findUser = await User.findOne({ email: email });

        if (!findUser) {
            return res.status(400).json({ error: "Incorrect username and password" });
        }
        if (findUser.isBlocked) {
            return res.status(400).json({ error: "User is blocked" });
        }
        const isPasswordValid = await bcrypt.compare(password, findUser.password);
        if (!isPasswordValid) {
            return res.status(400).json({ error: "Incorrect username and password" });
        }
        req.session.userId = findUser._id;
        req.session.email = findUser.email;
        console.log("Session data set on login:", req.session);
        if (findUser.isAdmin) {
            req.session.isAdmin = true;
            return res.status(200).json({ success: true, redirect: '/adminDashboard' });
        } else {
            req.session.isAdmin = false;
            const Category = await category.find({ isDeleted: false });
            const Product = await product.find({ isDelete: false });
            return res.status(200).json({ success: true, redirect: '/userHomePage' });
        }
    } catch (error) {
        console.error('Error during login:', error);
        return res.status(500).json({ error: 'Something went wrong. Please try again.' });
    }
};




const loadSignup = async (req, res) => {
    try {
        return res.render('user/signupPage');
    } catch (error) {
        console.log('Signup page not loading', error);
        res.status(500).send('Server Error');
    }
};

function generateOtp() {
    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    console.log('Generated OTP:', otp);
    return otp;
}

async function sendVerificationEmail(email, otp) {
    try {
        console.log('Sending email to:', email);
        console.log('OTP:', otp);

        const transporter = nodemailer.createTransport({
            service: 'gmail',
            port: 587,
            secure: false,
            requireTLS: true,
            auth: {
                user: process.env.NODEMAILER_EMAIL,
                pass: process.env.NODEMAILER_PASSWORD,
            }
        });

        const info = await transporter.sendMail({
            from: process.env.NODEMAILER_EMAIL,
            to: email,
            subject: "Verify your account",
            text: `Your OTP is ${otp}`,
            html: `<b> Your OTP: ${otp} </b>`,
        });

        
        console.log('Email info:', info);
        return info.accepted.length > 0;
    } catch (error) {
        console.error('Error sending email', error);
        return false;
    }
}

const generateReferralCode = async () => {
  let code;
  let isUnique = false;

  while (!isUnique) {
      // Generate a random alphanumeric string
      code = Math.random().toString(36).substring(2, 8).toUpperCase(); // e.g., 'A1B2C3'

      // Check if code already exists in the database
      const existingUser = await User.findOne({ referralCode: code });
      if (!existingUser) {
          isUnique = true;
      }
  }
  return code;
};

const signup = async (req, res) => {
    try {
        const { name, email, password,referralUsed } = req.body;
        const findUser = await User.findOne({ email });
        if (findUser) {
            return res.status(400).json({ error: "Email already exists" });
        }
        const otp = generateOtp();
        const emailSent = await sendVerificationEmail(email, otp);
        if (!emailSent) {
            return res.json({ error: 'email-error' });
        }
        
        req.session.userOtp = otp;
        req.session.userData = { name, email, password,referralUsed };
        console.log('Stored OTP in session:', req.session.userOtp);
        // res.render('verify-otp')
        
        // Consider sending a success message here if OTP form rendering is handled separately
        res.json({ success: true });

        // If rendering the OTP form directly
        // res.render("user/otpForm");
        console.log("OTP sent:", otp);

    } catch (error) {
        console.error('Error during signup:', error);
        res.redirect("/error");
    }
};



const securePassword=async(password)=>{
    try {
        const passwordHash=await bcrypt.hash(password,10)
        return passwordHash;
    } catch (error) {
        
    }
}


const otpPage=async(req,res)=>{
    res.render("user/otpForm")
}

const verifyOTP=async(req,res)=>{       
    try {
       const {otp}=req.body;
       console.log('Received OTP from form:', otp);
       console.log('Session OTP:', req.session.userOtp);
       if(otp===req.session.userOtp){
        const referralCode = await generateReferralCode();

        const user=req.session.userData
        const passwordHash=await securePassword(user.password)
        const saveUserData= new User({
            name:user.name,
            email:user.email,
            password:passwordHash,
            referralCode,
            referralUsed: user.referralUsed || null,
           // googleId: req.session.googleId || undefined // Use undefined instead of null
        })
        if (user.referralUsed) {
          const referrer = await User.findOne({ referralCode: user.referralUsed });
    
          if (referrer) {
            // Add $50 to the referrer’s wallet
            await addReferralBonusToWallet(referrer._id);
          }
        }
        await saveUserData.save()
        req.session.user=saveUserData._id;
        res.json({success:true,redirectUrl:"/login"})
       }else{
        res.status(400).json({success:false,message:"Invalid OTP,please try again"})
       }
    } catch (error) {
        console.error("Error Verify OTP",error);
        res.status(500).json({success:false,message:"An error occured"})
        
    }
}

const resendOtp = async (req, res) => {
    console.log("Resend OTP route hit");  // Debugging log

    try {
        // Ensure session is available
        if (!req.session || !req.session.userData) {
            return res.status(400).json({ success: false, message: "No user session data" });
        }

        const { email } = req.session.userData;
        if (!email) {
            return res.status(400).json({ success: false, message: "Email not found in session" });
        }

        const otp = generateOtp();
        req.session.userOtp = otp;

        const emailSent = await sendVerificationEmail(email, otp);
        if (emailSent) {
            console.log("Resend OTP", otp);
            return res.status(200).json({ success: true, message: "OTP Resent Successfully" });
        } else {
            return res.status(500).json({ success: false, message: "Failed to resend OTP" });
        }
    } catch (error) {
        console.error("Error resending OTP", error);
        return res.status(500).json({ success: false, message: "Internal Server Error" });
    }
};

// const loadUserHomePage = async (req, res) => {
//     const page = parseInt(req.query.page) || 1;
//     const limit = 6;
//     const skip = (page - 1) * limit;
  
//     try {
    
//      const  offer= await Offer.find({isDelete: false,offerStartDate: { $lte: new Date() }});
//       const totalProducts = await product.countDocuments({ isDelete: false });
//       const totalPages = Math.ceil(totalProducts / limit);

//       const user = await User.findById(req.session.userId).lean();
    
//       const cart = await Cart.findOne({ user: user._id }).populate("items.product");
//       const wishlist =await Wishlist.findOne({user:req.session.userId}).populate('items.product')
      
//       const products = await product.find({ isDelete: false })
//         .skip(skip)
//         .limit(limit)
//         .lean();
  
//         let cartCount = 0;
//         if (cart && cart.items && cart.items.length > 0) {
//            cart.items.forEach(item => {
//            cartCount += item.quantity; 
//         });
//     } 
//     let wishlistCount=0;
//       if(wishlist){
//         wishlistCount  = wishlist.items.length;
//       }    
//       const Category = await category.find({ isDeleted: false }).lean();
  
//       res.render('user/menuPage', {
//         user: user, 
//         Category: Category,
//         products: products,
//         currentPage: page,
//         totalPages: totalPages,
//         cartCount,
//         wishlistCount,
//         offer
//       });
//     } catch (error) {
//       console.error('Error loading user home page:', error);
//       res.status(500).send('An error occurred while loading the page');
//     }
//   };
  
const loadUserHomePage = async (req, res) => {
  const page = parseInt(req.query.page) || 1;
  const limit = 6;
  const skip = (page - 1) * limit;

  try {
      const Category = await category.find({ isDeleted: false }).lean();
      const  offer= await Offer.find({isDelete: false,offerStartDate: { $lte: new Date() }});
    const totalProducts = await product.countDocuments({ isDelete: false });
    const totalPages = Math.ceil(totalProducts / limit);

    const user = await User.findById(req.session.userId).lean();
  
    const cart = await Cart.findOne({ user: user._id }).populate("items.product");
    const wishlist =await Wishlist.findOne({user:req.session.userId}).populate('items.product')

   
      const products = await product.find({ isDelete: false }).populate('offer')
      .skip(skip)
      .limit(limit)
      .lean();

      let cartCount = 0;
      if (cart && cart.items && cart.items.length > 0) {
         cart.items.forEach(item => {
         cartCount += item.quantity; 
      });
  } 
  
  let wishlistCount=0;
    if(wishlist){
      wishlistCount  = wishlist.items.length;
    }  
    
    res.render('user/menuPage', {
      user: user, 
      Category: Category,
      products: products,
      currentPage: page,
      totalPages: totalPages,
      cartCount,
      wishlistCount,
      offer
    });
  } catch (error) {
    console.error('Error loading user home page:', error);
    res.status(500).send('An error occurred while loading the page');
  }
};

  const single_ProductView=async(req,res)=>{
    try {
      const { id } = req.params; 
      const Product = await product.findById(id).populate('category_id')
      const Category=await product.find({category_id:Product.category_id._id}) 
      res.render('user/single-product', { Product,Category});
    } catch (err) {
      console.error(err);
      res.redirect('/userHomePage');
    }
  }
  const search = async (req, res) => {
    
    try {
        const page = parseInt(req.query.page) || 1;
        const limit = 6;
        const skip = (page - 1) * limit;
        const search = req.query.search || '';
        const minPrice = req.query.min_price ? parseFloat(req.query.min_price) : 0;
        const maxPrice = req.query.max_price ? parseFloat(req.query.max_price) : Infinity;
        const sort = req.query.sort || 'newest';

        let query = { 
          productname: { $regex: search, $options: 'i' },
          price: { $gte: minPrice, $lte: maxPrice }
        };

        let sortObj = {};
        switch(sort) {
          case 'name_asc':
            sortObj = { productname: 1 };
            break;
          case 'name_desc':
            sortObj = { productname: -1 };
            break;
          case 'price_asc':
            sortObj = { price: 1 };
            break;
          case 'price_desc':
            sortObj = { price: -1 };
            break;
          case 'newest':
          default:
            sortObj = { createdAt: -1 };
        }

        const products = await product.find(query)
          .sort(sortObj)
          .skip(skip)
          .limit(limit);
        const totalProducts = await product.countDocuments(query);
        const totalPages = Math.ceil(totalProducts / limit);
        const Category = await category.find();
        const user = await User.findById(req.session.userId)
        const cart = await Cart.findOne({ user: user._id }).populate("items.product"); 
        let cartCount = 0;
        if (cart && cart.items) {
          cartCount = cart.items.length;
        }
        const wishlist =await Wishlist.findOne({user:req.session.userId}).populate('items.product')
        let wishlistCount=0;
        if(wishlist){
          wishlistCount  = wishlist.items.length;
        }  
        res.render('user/menuPage', {
        user:user,
        products:products,
        currentPage: page,
        totalPages,
        Category: Category,
        cartCount:cartCount,
        wishlistCount:wishlistCount,
        
        searchParams: {
        search,
        minPrice,
        maxPrice,
        sort,
          }
        });
      } catch (error) {
        console.error(error);
        res.status(500).send('An error occurred');
      }
    } 
  
  
  
  
  

  const logout = (req, res) => {
    req.session.destroy((err) => {
      if (err) {
        console.log(err);
      } else {
        res.redirect("/");
      }
    });
  };



module.exports = {
    loadIndexPage,
    loadLogin,
    login,
    loadSignup,
    loadUserHomePage,
    signup,
    verifyOTP,
    resendOtp,
    logout,
    single_ProductView,
    otpPage,
    search
};



const search = async (req, res) => {
    
  try {
      const page = parseInt(req.query.page) || 1;
      const limit = 6;
      const skip = (page - 1) * limit;
      const search = req.query.search || '';
      const minPrice = req.query.min_price ? parseFloat(req.query.min_price) : 0;
      const maxPrice = req.query.max_price ? parseFloat(req.query.max_price) : Infinity;
      const sort = req.query.sort || 'newest';

      let query = { 
        productname: { $regex: search, $options: 'i' },
        price: { $gte: minPrice, $lte: maxPrice }
      };

      let sortObj = {};
      switch(sort) {
        case 'name_asc':
          sortObj = { productname: 1 };
          break;
        case 'name_desc':
          sortObj = { productname: -1 };
          break;
        case 'price_asc':
          sortObj = { price: 1 };
          break;
        case 'price_desc':
          sortObj = { price: -1 };
          break;
        case 'newest':
        default:
          sortObj = { createdAt: -1 };
      }

      const products = await product.find(query)
        .sort(sortObj)
        .skip(skip)
        .limit(limit);
      const totalProducts = await product.countDocuments(query);
      const totalPages = Math.ceil(totalProducts / limit);
      const Category = await category.find();
      const user = await User.findById(req.session.userId)
      const cart = await Cart.findOne({ user: user._id }).populate("items.product"); 
      let cartCount = 0;
      if (cart && cart.items) {
        cartCount = cart.items.length;
      }
      const wishlist =await Wishlist.findOne({user:req.session.userId}).populate('items.product')
      let wishlistCount=0;
      if(wishlist){
        wishlistCount  = wishlist.items.length;
      }  
      res.render('user/menuPage', {
      user:user,
      products:products,
      currentPage: page,
      totalPages,
      Category: Category,
      cartCount:cartCount,
      wishlistCount:wishlistCount,
      
      searchParams: {
      search,
      minPrice,
      maxPrice,
      sort,
        }
      });
    } catch (error) {
      console.error(error);
      res.status(500).send('An error occurred');
    }
  } 







  const verifyOTP=async(req,res)=>{       
    try {
       const {otp}=req.body;
       console.log('Received OTP from form:', otp);
       console.log('Session OTP:', req.session.userOtp);
       if(otp===req.session.userOtp){
        //const referralCode = await generateReferralCode();

        const user=req.session.userData
        const passwordHash=await securePassword(user.password)
        const saveUserData= new User({
            name:user.name,
            email:user.email,
            password:passwordHash,
            referralCode: await generateReferralCode(),
            hasUsedReferral: !!user.referralUsed, 
           // googleId: req.session.googleId || undefined // Use undefined instead of null
        })
        await saveUserData.save()
        if (user.referralUsed) {
          const referrer = await User.findOne({ referralCode: user.referralUsed });
          if (referrer) {
            // Credit the referrer with 50 INR
            await addReferralBonus(referrer._id, 'Referred a user');
    
            // Credit the new user with 50 INR
            await addReferralBonus(savedUser._id, 'Used referral code');
          }
          
        }
       
        req.session.user=saveUserData._id;
        res.json({success:true,redirectUrl:"/login"})
       }else{
        res.status(400).json({success:false,message:"Invalid OTP,please try again"})
       }
    } catch (error) {
        console.error("Error Verify OTP",error);
        res.status(500).json({success:false,message:"An error occured"})
        
    }
}

async function addReferralBonus(userId, description) {
  const wallet = await wallet.findOne({ user: userId });
  if (wallet) {
    wallet.balanceAmount += 50;
    wallet.wallet_history.push({
      date: new Date(),
      amount: 50,
      description,
      transactionType: 'credited',
    });
    await wallet.save();
  } else {
    // Create a new wallet if none exists
    const newWallet = new wallet({
      user: userId,
      balanceAmount: 50,
      wallet_history: [
        {
          date: new Date(),
          amount: 50,
          description,
          transactionType: 'credited',
        },
      ],
    });
    await newWallet.save();
  }
}













































































const Order=require('../../models/orderModel')
const PDFDocument = require('pdfkit');
const ExcelJS = require('exceljs');
const Coupon=require('../../models/couponModel')



const generateSalesReport = async (req, res) => {
    try {
        const { startDate, endDate, reportType } = req.body;
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999); 
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            return res.status(400).json({ error: 'Invalid start or end date' });
        }
        const orders = await Order.find({
            placedAt: { $gte: start, $lte: end }
        }).populate('user', 'username email')
          .populate('items.product', 'product_name category')
          .sort({ placedAt: -1 });
         
        if (orders.length === 0) {
            return res.status(404).json({ message: 'No orders found for the specified date range' });
        }
        const reportData = calculateReportData(orders);

        reportData.orders = orders.map(order => ({
            orderId: order.orderId,
            orderDate: order.placedAt,
            userName: order.user ? (order.user.username || order.user.email) : 'Unknown User', 
            items: order.items.map(item => ({
                productName: item.product ? item.product.product_name : 'Unknown Product',
                quantity: item.quantity,
                unitPrice: item.price / item.quantity,
                offerPrice: item.discountAmount || item.price,
                lineTotal: (item.discountAmount || item.price)
            })),
            subtotal: order.items.reduce((sum, item) => sum + ((item.discountAmount || item.price)), 0),
            couponCode: order.couponCode || null,
            couponDiscount: order.discountAmount || 0,
            totalAmount: order.totalAmount
        }));
        reportData.recentOrders = orders.slice(0, 5).map(order => ({
            orderId: order.orderId,
            date: order.placedAt.toISOString().split('T')[0],
            status: order.orderStatus
        }));
        if (reportType === 'pdf') {
            const pdfBuffer = await generatePDFReport(reportData);
            res.contentType('application/pdf');
            return res.send(pdfBuffer);
        } else if (reportType === 'excel') {
            const excelBuffer = await generateExcelReport(reportData);
            res.contentType('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
            return res.send(excelBuffer);
        } else {
            return res.json(reportData);
        }
    } catch (error) {
        console.error('Error generating report:', error);
        res.status(500).json({ error: 'An error occurred while generating the report', details: error.message });
    }
};






function generatePDFReport(data) {
    return new Promise((resolve, reject) => {
        const doc = new PDFDocument({ margin: 50, size: 'A4' });
        let buffers = [];

        doc.on('data', buffers.push.bind(buffers));
        doc.on('end', () => {
            const pdfData = Buffer.concat(buffers);
            resolve(pdfData);
        });

        // Title and Header
        doc.fontSize(22).fillColor('#333').text('Sales Report', { align: 'center', underline: true });
        doc.moveDown(2);

        // Divider
        generateHr(doc, doc.y + 10);

        // Sales Information
        doc.fontSize(14).fillColor('#000').text('Summary:', { underline: true });
        doc.moveDown(1);
        
        const summaryData = [
            { label: 'Total Orders:', value: data.totalOrders },
            { label: 'Original Total:', value: `Rs. ${data.originalTotal.toFixed(2)}` },
            { label: 'Offer Discount:', value: `Rs. ${data.offerDiscount.toFixed(2)}` },
            { label: 'Total After Offers:', value: `Rs. ${data.afterOfferTotal.toFixed(2)}` },
            { label: 'Coupon Discount:', value: `Rs. ${data.totalCouponDiscount.toFixed(2)}` },
            { label: 'Final Total:', value: `Rs. ${data.finalTotal.toFixed(2)}` }
        ];
        
        
     
        


        summaryData.forEach((item, index) => {
            doc.fontSize(12)
               .text(item.label, 50, doc.y)
               .text(item.value, 200, doc.y - 12, { align: 'left' });
            if (index < summaryData.length - 1) doc.moveDown(0.5);
        });

        generateHr(doc, doc.y + 20);

        // Detailed Order Section
        doc.fontSize(14).fillColor('#000').text('Detailed Order List:', { underline: true });
        doc.moveDown(1);

        for (const order of data.orders) {
            // Add Order header
            doc.fontSize(12).fillColor('#333')
               .text(`Order ID: ${order.orderId}`, 50, doc.y)
               .text(`Order Date: ${new Date(order.orderDate).toLocaleDateString()}`, 400, doc.y - 12, { align: 'right' });
            doc.moveDown(0.5);
            doc.text(`User: ${order.userName}`, 50, doc.y); // Add this line
            doc.moveDown(0.5);

            // Table header
            const tableTop = doc.y;
            doc.fontSize(10).fillColor('#555');
            [
                { text: 'Item', x: 50, width: 200 },
                { text: 'Qty', x: 250, width: 30, align: 'center' },
                { text: 'Unit Price', x: 280, width: 80, align: 'right' },
                { text: 'Offer Price', x: 360, width: 80, align: 'right' },
                { text: 'Line Total', x: 440, width: 80, align: 'right' }
            ].forEach(header => {
                doc.text(header.text, header.x, tableTop, { width: header.width, align: header.align || 'left' });
            });

            generateHr(doc, doc.y + 10);
            doc.moveDown(0.5);

            // Add each item in the order
            let orderSubtotal = 0;
            for (const item of order.items) {
                const itemTop = doc.y;
                doc.fontSize(10).fillColor('#000');
                doc.text(item.productName || 'Unknown Product', 50, itemTop, { width: 200 });
                doc.text(item.quantity.toString(), 250, itemTop, { width: 30, align: 'center' });
                doc.text(`Rs. ${item.unitPrice.toFixed(2)}`, 280, itemTop, { width: 80, align: 'right' });
                doc.text(`Rs. ${item.offerPrice.toFixed(2)}`, 360, itemTop, { width: 80, align: 'right' });
                doc.text(`Rs. ${item.lineTotal.toFixed(2)}`, 440, itemTop, { width: 80, align: 'right' });
                doc.moveDown(0.5);
                orderSubtotal += item.lineTotal;
            }

            // Order total and coupon
            generateHr(doc, doc.y + 5);
            doc.moveDown(0.5);
            doc.fontSize(10).fillColor('#333');
            doc.text(`Subtotal: Rs. ${orderSubtotal.toFixed(2)}`, 350, doc.y, { width: 150, align: 'right' });
            if (order.couponCode) {
                doc.moveDown(0.5);
                doc.text(`Coupon (${order.couponCode}): -Rs. ${order.couponDiscount.toFixed(2)}`, 350, doc.y, { width: 150, align: 'right' });
            }
            doc.moveDown(0.5);
            doc.fontSize(12).fillColor('#000');
            doc.text(`Total: Rs. ${order.totalAmount.toFixed(2)}`, 350, doc.y, { width: 150, align: 'right' });

            doc.moveDown(2);
        }

        // Footer
        const footerPosition = doc.page.height - 50;
        doc.fontSize(10).fillColor('#888')
           .text('Generated on: ' + new Date().toLocaleDateString(), 50, footerPosition, { align: 'center', width: 500 });
        
        doc.fontSize(10).text('Thank you for your business!', { align: 'center', width: 500 });

        // Finalize PDF file
        doc.end();
    });
}

// Helper function to draw a horizontal line
function generateHr(doc, y) {
    doc.strokeColor('#aaaaaa')
        .lineWidth(1)
        .moveTo(50, y)
        .lineTo(550, y)
        .stroke();
}



async function generateExcelReport(data) {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Sales Report');

    worksheet.columns = [
        { header: 'Metric', key: 'metric', width: 30 },
        { header: 'Value', key: 'value', width: 15 }
    ];

    worksheet.addRows([
        { metric: 'Total Orders', value: data.totalOrders },
        { metric: 'Original Total', value: data.originalTotal },
        { metric: 'Offer Discount', value: data.offerDiscount },
        { metric: 'Total After Offers', value: data.afterOfferTotal },
        { metric: 'Coupon Discount', value: data.totalCouponDiscount },
        { metric: 'Final Total', value: data.finalTotal }
    ]);

    return await workbook.xlsx.writeBuffer();
}

function calculateReportData(orders) {
    let originalTotal = 0;
    let afterOfferTotal = 0;
    let totalCouponDiscount = 0;
    let finalTotal = 0;

    orders.forEach(order => {
        const originalOrderTotal = order.items.reduce((sum, item) => sum + (item.price), 0);
        const afterOfferOrderTotal = order.items.reduce((sum, item) => 
            sum + ((item.discountAmount || item.price) * item.quantity), 0);
        const couponDiscount = order.discountAmount || 0;
        
        originalTotal += originalOrderTotal;
        afterOfferTotal += afterOfferOrderTotal;
        totalCouponDiscount += couponDiscount;  
        finalTotal += order.totalAmount;
    });

    return {
        totalOrders: orders.length,
        originalTotal,
        offerDiscount: originalTotal - afterOfferTotal,
        afterOfferTotal,
        totalCouponDiscount,
        finalTotal: afterOfferTotal - totalCouponDiscount 
    };
}
const sales_Chart = async (req, res) => {
    try {
      const orderData = await Order.aggregate([
        {
          $group: {
            _id: { $month: "$createdAt" },  
            orderCount: { $sum: 1 }          
          }
        },
        {
          $project: {
            month: {
              $let: {
                vars: {
                  monthsInString: [, 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
                },
                in: {
                  $arrayElemAt: ['$$monthsInString', '$_id']
                }
              }
            },
            orderCount: 1,
            _id: 0
          }
        },
        { $sort: { _id: -1 } },             
        { $limit: 5 },                     
        { $sort: { _id: 1 } }               
      ]);
  
      res.json(orderData);
    } catch (error) {
      console.error('Error fetching order data:', error);
      res.status(500).json({ error: 'Internal server error' });
    }
  };




module.exports ={
    generateSalesReport,
    sales_Chart

}



<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single Product View with Cursor Zoom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap core css -->
  <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" />
  
  <!--owl slider stylesheet -->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
  <!-- nice select  -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css" integrity="sha512-CruCP+TD3yXzlvvijET8wV5WxxEh5H8P4cmz0RFbKK6FlZ2sYl3AEsKlLPHbniXKSrDdFewhbmBK5skbdsASbQ==" crossorigin="anonymous" />
  <!-- font awesome style -->
  <link href="/css/font-awesome.min.css" rel="stylesheet" />

  <!-- Custom styles for this template -->
  <link href="/css/style.css" rel="stylesheet" />
  <!-- responsive style -->
  <link href="/css/responsive.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/ar.css">
    <style>

        /* Main image container for zoom effect */
        .product-image-container {
            width: 100%;
            height: auto;
            overflow: hidden;
            position: relative;
        }

        /* Styling for zoom effect on the main image */
        .product-image {
            width: 100%;
            height: auto;
            transition: transform 0.3s ease, transform-origin 0.3s ease;
            cursor: pointer;
        }

        .product-image-container:hover .product-image {
            transform: scale(1.5); /* Zoom in the image */
        }

        /* Thumbnail images */
        .thumbnail-images img {
            width: 75%;
            height: auto;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .active-thumbnail {
            border: 2px solid #007bff;
        }

        /* Vertical thumbnail styling */
        .thumbnail-images {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .product-image {
                transform: none;
            }

            .thumbnail-images {
                flex-direction: row;
                overflow-x: auto;
            }

            .thumbnail-images img {
                margin-right: 10px;
                margin-bottom: 0;
                width: 75px;
            }
        }

        /* Breadcrumb styling */
        .breadcrumb-item a {
            text-decoration: none;
        }

        /* Pagination styling */
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .pagination a {
            text-decoration: none;
        }

        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        .breadcrumb {
            background-color: #f8f9fa; /* Light background for breadcrumb */
            border-radius: 0.375rem; /* Rounded corners */
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }

        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
            color: #6c757d; /* Gray color for separator */
        }

        .breadcrumb-item a {
            text-decoration: none;
            color: #007bff; /* Bootstrap primary color */
        }

        .breadcrumb-item a:hover {
            text-decoration: underline;
        }

        .breadcrumb-item.active {
            color: #6c757d; /* Gray color for active item */
        }
        .food_section .filters_menu {
  padding: 0;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -ms-flex-wrap: wrap;
      flex-wrap: wrap;
  -webkit-box-pack: center;
      -ms-flex-pack: center;
          justify-content: center;
  list-style-type: none;
  margin: 45px 0 20px 0;
}

.food_section .filters_menu li {
  padding: 7px 25px;
  cursor: pointer;
  border-radius: 25px;
}

.food_section .filters_menu li.active {
  background-color: #222831;
  color: #ffffff;
}

.food_section .box {
  position: relative;
  margin-top: 25px;
  background-color: #ffffff;
  border-radius: 10px;
  color: #ffffff;
  border-radius: 15px;
  overflow: hidden;
  background: linear-gradient(to bottom, #f1f2f3 25px, #222831 25px);
}

.food_section .box .img-box {
  background: #f1f2f3;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: center;
      -ms-flex-pack: center;
          justify-content: center;
  -webkit-box-align: center;
      -ms-flex-align: center;
          align-items: center;
  height: 215px;
  border-radius: 0 0 0 45px;
  margin: -1px;
  padding: 25px;
}

.food_section .box .img-box img {
  max-width: 100%;
  max-height: 145px;
  -webkit-transition: all .2s;
  transition: all .2s;
}

.food_section .box .detail-box {
  padding: 25px;
}

.food_section .box .detail-box h5 {
  font-weight: 600;
  
}

.food_section .box .detail-box p {
  font-size: 15px;
}

.food_section .box .detail-box h6 {
  margin-top: 10px;
}

.food_section .box .options {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: justify;
      -ms-flex-pack: justify;
          justify-content: space-between;
}

.food_section .box .options a {
  width: 40px;
  height: 40px;
  border-radius: 100%;
  background: #ffbe33;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: center;
      -ms-flex-pack: center;
          justify-content: center;
  -webkit-box-align: center;
      -ms-flex-align: center;
          align-items: center;
}
.food_section .box .option a {
  width: 40px;
  height: 40px;
  border-radius: 100%;
  background: #f02975;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: center;
      -ms-flex-pack: center;
          justify-content: center;
  -webkit-box-align: center;
      -ms-flex-align: center;
          align-items: center;
}
.food_section .box .options a svg {
  width: 18px;
  height: auto;
  fill: #ffffff;
}

.food_section .box:hover .img-box img {
  -webkit-transform: scale(1.1);
          transform: scale(1.1);
}

.food_section .btn-box {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: center;
      -ms-flex-pack: center;
          justify-content: center;
  margin-top: 45px;
}

.food_section .btn-box a {
  display: inline-block;
  padding: 10px 55px;
  background-color: #ffbe33;
  color: #ffffff;
  border-radius: 45px;
  -webkit-transition: all 0.3s;
  transition: all 0.3s;
  border: none;
}

.food_section .btn-box a:hover {
  background-color: #e69c00;
}

    </style>
</head>

<body>
  <header class="header_section bg-dark fixed-header">
    <div class="container">
      <nav class="navbar navbar-expand-lg custom_nav-container">
        <a class="navbar-brand" href="/userHomePage">
          <span>
            Footwear
          </span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
          <span class=""> </span>
        </button>
  
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mx-auto">
            <li class="nav-item active">
              <a class="nav-link" href="/userHomePage">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">About us</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Contact us</a>
            </li>
          </ul>
  
          <!-- User Profile and Cart Section -->
          <div class="user_option">
            <a class="cart_link position-relative" href="/getCartPage">
              <!-- Cart Icon SVG -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 456.029 456.029" width="50" height="50">
                <path d="M345.6 338.862c-29.184 0-53.248 23.552-53.248 53.248s23.552 53.248 53.248 53.248 53.248-23.552 53.248-53.248-23.552-53.248-53.248-53.248zM439.296 84.91h-330.56l-5.12-34.304c-2.048-13.824-21.504-30.72-44.544-30.72H20.48C9.216 19.886 0 29.102 0 40.366S9.216 60.846 20.48 60.846h41.472c2.56 0 4.608 2.048 5.12 4.608l31.744 216.064c4.096 27.136 27.648 47.616 55.296 47.616h212.992c26.624 0 49.664-18.944 55.296-45.056l33.28-166.4c4.096-21.504-3.072-32.256-14.336-34.304zM215.04 389.55c-1.024-28.16-24.576-50.688-52.736-50.688-29.696 1.536-52.224 26.112-51.2 55.296 1.024 28.16 24.064 50.688 52.224 50.688 29.184 0 52.224-24.576 51.712-55.296z"/>
              </svg>
              <!-- Cart Count Badge -->
              <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                <%= cartCount %>
              </span>
            </a>
            <a class="cart_link position-relative" href="/wishlist">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50" fill="red">
                <path d="M462.3 62.7C407 7.4 324.8 23.9 270.1 79.1L256 93.3l-14.1-14.2c-54.8-55.2-136.9-71.7-192.2-16.4S-7.4 199.9 48 255.2L239 445.5c7.4 7.5 19.6 7.5 27 0l205.4-205.4c55.2-54.8 71.7-136.9 16.4-192.2z"/>
              </svg>
              <span data-toggle="tooltip" data-placement="bottom" title="<%= wishlistCount %>" id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                <%= wishlistCount %>
              </span>
            </a>
            <p class="user_proname"><%= user.name %></p>
  
            <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="loginDropdown" data-bs-toggle="dropdown">
                <i class="fa fa-user" aria-hidden="true"></i>
              </button>
  
              <div class="dropdown-menu">
                <a href="/profilePage" class="profile-link">
                  <img src="/images/profile.png" class="profile-avatar"> Profile
                </a>
                <a href="/orderHistory" class="profile-link">
                  <img src="/images/purchase-order.png" class="profile-avatar"> Orders
                </a>
                <a href="/getCartPage" class="profile-link">
                  <img src="/images/shopping-cart (1).png" class="profile-avatar"> Cart
                </a>
                <a href="wishlist" class="profile-link">
                  <img src="/images/wishlist.png" class="profile-avatar"> Wishlist
                </a>
                <a href="/loadWalletPage" class="profile-link">
                  <img src="/images/wallet.png" class="profile-avatar"> Wallet
                </a>
                <a href="/logout"class="profile-link logout-link">
                  <img src="/images/shutdown.png" class="profile-avatar"> Logout
                </a>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/userHomePage">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Product Page</li>
        </ol>
    </nav>
    <div class="container mt-5">
        <div class="row">
            <!-- Thumbnails -->
            <div class="col-md-2 thumbnail-images">
                <img src="<%= Product.images[0] %>" class="img-fluid thumb" alt="Thumbnail 1" onclick="changeImage('<%= Product.images[0] %>')">
                <img src="<%= Product.images[1] %>" class="img-fluid thumb" alt="Thumbnail 2" onclick="changeImage('<%= Product.images[1] %>')">
                <img src="<%= Product.images[2] %>" class="img-fluid thumb" alt="Thumbnail 3" onclick="changeImage('<%= Product.images[2] %>')">
                <img src="<%= Product.images[3] %>" class="img-fluid thumb" alt="Thumbnail 4" onclick="changeImage('<%= Product.images[3] %>')">
            </div>

            <!-- Main Product Image -->
            <div class="col-md-5">
                <div class="product-image-container" id="imageContainer">
                    <img src="<%= Product.images[0] %>" id="mainProductImage" class="img-fluid product-image" alt="Product Image">
                </div>
            </div>

            <!-- Product Details: Price, Cart, Description, Stock -->
            <div class="col-md-5">
                <h2><%=Product.productname %></h2>
                <h3 class="text-danger">₹ <%= Product.price %></h3>
                <p class="<%= Product.stock > 0 ? 'text-success' : 'text-danger' %>">
                    <%= Product.stock > 0 ? `${Product.stock} In Stock` : 'Out of Stock' %>
                </p>
                <p>
                    <%= Product.description %>
                </p>
                <div class="mb-3">
                    <span class="text-warning">★ ★ ★ ★ ☆</span> (4.5)
                </div>
                <a class="wishlist-link btn btn-outline-dark" href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" stroke="red" fill="currentColor" class="bi bi-suit-heart" viewBox="0 0 16 16">
                        <path d="m8 6.236-.894-1.789c-.222-.443-.607-1.08-1.152-1.595C5.418 2.345 4.776 2 4 2 2.324 2 1 3.326 1 4.92c0 1.211.554 2.066 1.868 3.37.337.334.721.695 1.146 1.093C5.122 10.423 6.5 11.717 8 13.447c1.5-1.73 2.878-3.024 3.986-4.064.425-.398.81-.76 1.146-1.093C14.446 6.986 15 6.131 15 4.92 15 3.326 13.676 2 12 2c-.777 0-1.418.345-1.954.852-.545.515-.93 1.152-1.152 1.595zm.392 8.292a.513.513 0 0 1-.784 0c-1.601-1.902-3.05-3.262-4.243-4.381C1.3 8.208 0 6.989 0 4.92 0 2.755 1.79 1 4 1c1.6 0 2.719 1.05 3.404 2.008.26.365.458.716.596.992a7.6 7.6 0 0 1 .596-.992C9.281 2.049 10.4 1 12 1c2.21 0 4 1.755 4 3.92 0 2.069-1.3 3.288-3.365 5.227-1.193 1.12-2.642 2.48-4.243 4.38z" />
                    </svg>
                    Add to Wishlist
                </a>
<!-- Specifications Modal -->
<button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#specificationsCollapse" aria-expanded="false" aria-controls="specificationsCollapse">
  View Specifications
</button>

<div class="collapse" id="specificationsCollapse">
  <div class="card card-body">
    <ul>
      <% Product.specifications.forEach(spec => { %>
        <li><strong><%= spec.key %>:</strong> <%= spec.value %></li>
      <% }); %>
    </ul>
  </div>
</div>
                <div class="d-grid gap-2 mt-4">
                    <a id="addToCart" href="#" class="btn btn-primary btn-lg"onclick="addToCart('<%= Product._id %>')">Add to Cart</a>
                </div>
            </div>
        </div>
    </div>
    
    <section class="food_section layout_padding">
        <div class="container">
          <div class="heading_container heading_center">
            <h2>Related Products</h2>
          </div>
          <div class="filters-content">
            <div class="row grid">
              <% Category.forEach(category => { %>
              <div class="col-sm-6 col-lg-4 all pizza">
                <div class="box">
                  <div>
                    <div class="img-box">
                      <img src="<%= category.images[0] %>" alt="">
                    </div>
                    <div class="detail-box">
                      <h5>
                        <%= category.productname %>
                      </h5>
                      <p>
                        <%= category.description %>
                      </p>
                      <div class="options">
                        <h6>₹ <%= category.price %></h6>
                        <a href="#">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 456.029 456.029" width="24" height="24" fill="currentColor">
                              <circle cx="345.6" cy="392.11" r="53.248"/>
                              <path d="M439.296,84.91c-1.024,0-2.56-0.512-4.096-0.512H112.64l-5.12-34.304C104.448,27.566,84.992,10.67,61.952,10.67H20.48
                                  C9.216,10.67,0,19.886,0,31.15c0,11.264,9.216,20.48,20.48,20.48h41.472c2.56,0,4.608,2.048,5.12,4.608l31.744,216.064
                                  c4.096,27.136,27.648,47.616,55.296,47.616h212.992c26.624,0,49.664-18.944,55.296-45.056l33.28-166.4
                                  C457.728,97.71,450.56,86.958,439.296,84.91z"/>
                              <path d="M215.04,389.55c-1.024-28.16-24.576-50.688-52.736-50.688c-29.696,1.536-52.224,26.112-51.2,55.296
                                  c1.024,28.16,24.064,50.688,52.224,50.688h1.024C193.536,443.31,216.576,418.734,215.04,389.55z"/>
                          </svg>
                      </a> 
                      </div>
                      <span class="text-warning">★ ★ ★ ★ ☆</span> (4.5)
                       <!-- Whish List -->
                  <div class="option">
                    <a class="bi bi-heart" href="">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" stroke="white" fill="currentColor" class="bi bi-suit-heart" viewBox="0 0 16 16">
                        <path d="m8 6.236-.894-1.789c-.222-.443-.607-1.08-1.152-1.595C5.418 2.345 4.776 2 4 2 2.324 2 1 3.326 1 4.92c0 1.211.554 2.066 1.868 3.37.337.334.721.695 1.146 1.093C5.122 10.423 6.5 11.717 8 13.447c1.5-1.73 2.878-3.024 3.986-4.064.425-.398.81-.76 1.146-1.093C14.446 6.986 15 6.131 15 4.92 15 3.326 13.676 2 12 2c-.777 0-1.418.345-1.954.852-.545.515-.93 1.152-1.152 1.595zm.392 8.292a.513.513 0 0 1-.784 0c-1.601-1.902-3.05-3.262-4.243-4.381C1.3 8.208 0 6.989 0 4.92 0 2.755 1.79 1 4 1c1.6 0 2.719 1.05 3.404 2.008.26.365.458.716.596.992a7.6 7.6 0 0 1 .596-.992C9.281 2.049 10.4 1 12 1c2.21 0 4 1.755 4 3.92 0 2.069-1.3 3.288-3.365 5.227-1.193 1.12-2.642 2.48-4.243 4.38z"/>
                      </svg>
                    </a>
                  </div>
                    </div>
                  </div>
                </div>
              </div>
              <% }); %>
          </div>
        </div>
      </section>

    <!-- Pagination -->
    <nav aria-label="Page navigation example" class="mt-4">
        <ul class="pagination">
            <li class="page-item"><a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>
        </ul>
    </nav>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQery -->
  <script src="/js/jquery-3.4.1.min.js"></script>
  <!-- popper js -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"> -->
  </script>
  <!-- bootstrap js -->
  <script src="/js/bootstrap.js"></script>
  <!-- owl slider -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js">
  </script>
  <!-- isotope js -->
  <script src="https://unpkg.com/isotope-layout@3.0.4/dist/isotope.pkgd.min.js"></script>
  <!-- nice select -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
  <!-- custom js -->
  <script src="/js/custom.js"></script>
  <!-- Google Map -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh39n5U-4IoWpsVGUHWdqB6puEkhRLdmI&callback=myMap"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- End Google Map -->
   <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap JavaScript Bundle (includes Popper.js) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>



  <script>
    function changeImage(imageSrc) {
        document.getElementById('mainProductImage').src = imageSrc;
        document.querySelectorAll('.thumb').forEach(function(img) {
            img.classList.remove('active-thumbnail');
        });
        event.target.classList.add('active-thumbnail');
    }

    const productImage = document.getElementById('mainProductImage');
    const imageContainer = document.getElementById('imageContainer');

    imageContainer.addEventListener('mousemove', function(e) {
        const rect = imageContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        productImage.style.transformOrigin = `${x}px ${y}px`;
    });

    imageContainer.addEventListener('mouseleave', function() {
        productImage.style.transformOrigin = 'center';
    });
</script>

<script>
    async function addToCart(productId, quantity) {
      try {
        const response = await fetch('/postCartPage', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ productId: productId, quantity: quantity }),
        });
  
        if (response.ok) {
          const result = await response.json();
          Swal.fire({
            title: 'Success!',
            text: result.message,
            icon: 'success',
            timer: 1000,
            showConfirmButton: false,
          });
        } else {
          const result = await response.json();
          Swal.fire({
            title: 'Error!',
            text: result.message,
            icon: 'error',
          });
        }
      } catch (error) {
        Swal.fire({
          title: 'Error!',
          text: 'Something went wrong.',
          icon: 'error',
        });
      }
    }
    function toggleSpecs() {
    const specsContainer = document.getElementById("specsContainer");
    specsContainer.style.display = specsContainer.style.display === "none" ? "block" : "none";
}
  </script>

</body>

</html>
























<%- include('../../views/partials/userHeader') %>
<link rel="stylesheet" href="css/icomoon.css">
<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700" rel="stylesheet">
<style>
  .icon-hover-primary:hover {
border-color: #3b71ca !important;
background-color: white !important;
}

.icon-hover-primary:hover i {
color: #3b71ca !important;
}
.icon-hover-danger:hover {
border-color: #dc4c64 !important;
background-color: white !important;
}

.icon-hover-danger:hover i {
color: #dc4c64 !important;
}

  body {
    background-color: #f8f9fa;
    padding-top: 80px;
   
  }
  .sidebar {
    height: 100vh;
    background-color: #2c3e50;
    position: fixed;
    padding-top: 5rem;
  }
  .sidebar a {
    color: white;
    transition: background-color 0.3s ease;
  }
  .sidebar a:hover {
    background-color: #34495e;
  }
  .profile-header {
    background-color: #00bcd4; /* Teal 300 */
    color: white;
    padding: 20px;
    text-align: center;
  }
  .profile-pic {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 50%;
    border: 5px solid white;
    transition: transform 0.3s;
  }
  .profile-pic:hover {
    transform: scale(1.1);
  }
  .profile-card {
    margin-top: 20px;
    z-index: 1;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }
  .address-card {
    background: #f1f1f1;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 10px;
    position: relative;
    transition: background 0.3s;
  }
  .address-card:hover {
    background: #e1e1e1;
  }

  .dropdown-menu {
padding: 0;
margin: 0;
}

.profile-link {
display: flex;
align-items: center;
text-decoration: none;
color: inherit;
padding: 8px 16px;
transition: background-color 0.2s ease; 
}

.profile-link:hover {
background-color: #f0f0f0; 
}

.profile-avatar {
width: 24px; 
height: 24px;
border-radius: 50%; 
margin-right: 8px; 
}

.logout-link {
margin-bottom: 8px; 
}
.fixed-header {
position: fixed;
top: 0;
left: 0;
width: 100%;
z-index: 1000; 
}

.content-section {
margin-top: 20px; 
}

.breadcrumb {
          background-color: #f8f9fa; 
          border-radius: 0.375rem;
          padding: 0.75rem 1rem;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); 
      }

      .breadcrumb-item + .breadcrumb-item::before {
          content: ">";
          color: #6c757d;
      }

      .breadcrumb-item a {
          text-decoration: none;
          color: #007bff;
      }

      .breadcrumb-item a:hover {
          text-decoration: underline;
      }

      .breadcrumb-item.active {
          color: #6c757d; 
      }

      /* Coupon List Container */
.coupon-list-container {
    margin-top: 20px;
}

/* Individual Coupon Item */
.coupon-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 10px;
    transition: background-color 0.3s ease;
}

.coupon-item:hover {
    background-color: #e9ecef;
}

/* Coupon Code Text */
.coupon-code {
    font-size: 1.2em;
    font-weight: 600;
    color: #007bff;
    margin-right: 10px;
}

/* Coupon Description */
.coupon-description {
    font-size: 0.9em;
    color: #6c757d;
    max-width: 60%;
}

/* Copy Code Button */
.copy-btn {
    padding: 8px 12px;
    font-size: 0.9em;
    font-weight: 600;
    color: #ffffff;
    background-color: #28a745;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.copy-btn:hover {
    background-color: #218838;
}

.copy-btn:active {
    background-color: #1e7e34;
}

</style>
    <header class="header_section bg-dark fixed-header">
      <div class="container">
        <nav class="navbar navbar-expand-lg custom_nav-container">
          <a class="navbar-brand" href="/userHomePage">
            <span>
              Footwear
            </span>
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
            <span class=""> </span>
          </button>
    
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto">
              <li class="nav-item active">
                <a class="nav-link" href="/userHomePage">Home <span class="sr-only">(current)</span></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">About us</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">Contact us</a>
              </li>
            </ul>
    
            <!-- User Profile and Cart Section -->
            <div class="user_option">
              <a class="cart_link position-relative" href="/getCartPage">
                <!-- Cart Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 456.029 456.029" width="50" height="50">
                  <path d="M345.6 338.862c-29.184 0-53.248 23.552-53.248 53.248s23.552 53.248 53.248 53.248 53.248-23.552 53.248-53.248-23.552-53.248-53.248-53.248zM439.296 84.91h-330.56l-5.12-34.304c-2.048-13.824-21.504-30.72-44.544-30.72H20.48C9.216 19.886 0 29.102 0 40.366S9.216 60.846 20.48 60.846h41.472c2.56 0 4.608 2.048 5.12 4.608l31.744 216.064c4.096 27.136 27.648 47.616 55.296 47.616h212.992c26.624 0 49.664-18.944 55.296-45.056l33.28-166.4c4.096-21.504-3.072-32.256-14.336-34.304zM215.04 389.55c-1.024-28.16-24.576-50.688-52.736-50.688-29.696 1.536-52.224 26.112-51.2 55.296 1.024 28.16 24.064 50.688 52.224 50.688 29.184 0 52.224-24.576 51.712-55.296z"/>
                </svg>
                <!-- Cart Count Badge -->
                <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  <%= cartCount %>
                </span>
              </a>
              <a class="cart_link position-relative" href="/wishlist">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50" fill="red">
                  <path d="M462.3 62.7C407 7.4 324.8 23.9 270.1 79.1L256 93.3l-14.1-14.2c-54.8-55.2-136.9-71.7-192.2-16.4S-7.4 199.9 48 255.2L239 445.5c7.4 7.5 19.6 7.5 27 0l205.4-205.4c55.2-54.8 71.7-136.9 16.4-192.2z"/>
                </svg>
                <span data-toggle="tooltip" data-placement="bottom" title="<%= wishlistCount %>" id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  <%= wishlistCount %>
                </span>
              </a>
              <p class="user_proname"><%= user.name %></p>
    
              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="loginDropdown" data-bs-toggle="dropdown">
                  <i class="fa fa-user" aria-hidden="true"></i>
                </button>
    
                <div class="dropdown-menu">
                  <a href="/profilePage" class="profile-link">
                    <img src="/images/profile.png" class="profile-avatar"> Profile
                  </a>
                  <a href="/orderHistory" class="profile-link">
                    <img src="/images/purchase-order.png" class="profile-avatar"> Orders
                  </a>
                  <a href="/getCartPage" class="profile-link">
                    <img src="/images/shopping-cart (1).png" class="profile-avatar"> Cart
                  </a>
                  <a href="wishlist" class="profile-link">
                    <img src="/images/wishlist.png" class="profile-avatar"> Wishlist
                  </a>
                  <a href="/loadWalletPage" class="profile-link">
                    <img src="/images/wallet.png" class="profile-avatar"> Wallet
                  </a>
                  <a href="/logout"class="profile-link logout-link">
                    <img src="/images/shutdown.png" class="profile-avatar"> Logout
                  </a>
                </div>
              </div>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <section class="bg-light my-5">
    <div class="bg-light">
      <div class="container py-4">
        <!-- Breadcrumb -->
        <nav class="d-flex">
          <h6 class="mb-0 mt-5">
            <a href="/userHomePage" class="text-blue-50">Home</a>
            <span class="text-black-50 mx-2"> > </span>
            <a href="/getCartPage" class="text-blue-50"><u>Shopping cart</u></a>
            <span class="text-black-50 mx-2"> > </span>
            <a href="#" class="text-black"><u>CheckOut Page</u></a>
          </h6>
        </nav>
        <!-- Breadcrumb -->
      </div>
    </div>
    <div class="container mt-5">
      <div class="row">
        <!-- Cart Items Section -->
        <div class="col-md-6">
          <h3 class="mb-4">Checkout Page</h3>
          <% if (cart && cart.items.length > 0) { %> <% let total = 0; %> <%
          cart.items.forEach(item => { %>
          <div
            class="cart-item d-flex justify-content-between align-items-center border-bottom py-3"
          >
            <div class="item-info d-flex align-items-center">
              <img
                src="<%= item.product.images[0] %>"
                class="border rounded me-3"
                style="width: 96px; height: 96px"
              />
              <div class="ms-3">
                <h5><%= item.productName %></h5>
                <p class="text-muted">Quantity: <%= item.quantity %></p>
              </div>
            </div>
            <span class="fw-bold">₹<%= item.price %></span>
          </div>
          <% total += item.price; %> <% }) %>
          <!-- Total -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <h5>Total</h5>
            <span class="fw-bold">₹<%= total %></span>
          </div>
          <% } else { %>
          <p>Your Checkout Page is empty.</p>
          <% } %>


          <div class="col-md-6 coupon-list-container">
            <h4 class="mb-4">Available Coupons</h4>
            <% if (availableCoupons && availableCoupons.length > 0) { %>
              <% availableCoupons.forEach(coupon => { %>
                <div class="coupon-item">
                  <div>
                    <span class="coupon-code"><%= coupon.coupon_code %></span>
                    <p class="coupon-description"><%= coupon.coupon_description %></p>
                  </div>
                  <button 
                    class="copy-btn" 
                    onclick="copyCouponCode('<%= coupon.coupon_code %>')">
                    Copy Code
                  </button>
                </div>
              <% }) %>
            <% } else { %>
              <p>No available coupons at the moment.</p>
            <% } %>
          </div>

        </div>


        
        
    
        <!-- Address and Payment Section -->
        <div class="col-md-6">
          <div>
              <div class="card mb-3 border shadow-0">
                <div class="card-body">
                  <form id="applyCouponForm">
                    <div class="form-group">
                      <label class="form-label">Have coupon?</label>
                      <div class="input-group">
                        <input type="text" id="couponCode" class="form-control border" name="couponCode" placeholder="Coupon code" />
                        <button class="btn btn-light border">Apply</button>
                      </div>
                    </div>
                  </form>
                  <div id="couponResult"></div>
                </div>
              </div>
              <div class="card shadow-0 border">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <p class="mb-2">Total:</p>
                    <p id="cart-total" class="mb-2">₹<%= cart ? cart.total_price.toFixed(2) : '0.00' %></p>
                  </div>

                  
              
                  <div class="d-flex justify-content-between">
                    <p class="mb-2">Discount:</p>
                    <p class="mb-2 text-success" id="couponDiscount">00</p>
                  </div>
                  <div class="d-flex justify-content-between">
                    <p class="mb-2">Delivery Charges:</p>
                    <p class="mb-2 text-success" id="couponDiscount">50</p>
                  </div>
                  <hr />
                  <div class="d-flex justify-content-between">
                    <p class="mb-2">Net Amount:</p>
                    <p class="mb-2 fw-bold" id="couponTotal">₹<%= cart ? (cart.total_price + charges).toFixed(2) : '0.00' %></p>
                  </div>
              </div>
            </div>
              
          <h3 class="mb-4">Delivery Information</h3>
          <!-- Existing Addresses -->
          <div id="addressList">
            <label for="addressSelect" class="form-label">Select an Address</label>
            <div class="form-group">
              <select class="form-control" id="exampleFormControlSelect1">
                <option value="">Select address</option>
                <% address.forEach(function(Address) { %>
                <option value="<%= Address._id %>">
                  <%= Address.streetAddress %>, <%= Address.fullName %>
                </option>
                <% }); %>
              </select>
            </div>
          </div>
          <!-- Add New Address Button -->
           <div class="col-md-6">
             <button class="btn btn-outline-primary mt-3" id="addNewAddressBtn">
               + Add New Address
             </button>
           </div>
          <!-- New Address Form (Initially Hidden) -->
          <div id="newAddressForm" style="display: none">
            <form action="#" method="post" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="name" class="form-label">Full Name</label>
                <input type="text"class="form-control"id="name"placeholder="Enter your full name"/>
              </div>
              <div class="mb-3">
                <label for="address" class="form-label">Address</label>
                <textarea  class="form-control" id="address" rows="3" placeholder="Enter your address"></textarea>
              </div>
              <div class="mb-3">
                <label for="phoneNumber" class="form-label">Phone</label>
                <input  class="form-control" id="phoneNumber"placeholder="Enter your Phone"></input>
              </div>
              <div class="mb-3">
                <label for="state" class="form-label">State</label>
                <input  class="form-control" id="state"placeholder="Enter your state"></input>
              </div>
              <div class="mb-3">
                <label for="country" class="form-label">Country</label>
                <input  class="form-control" id="country"placeholder="Enter your country"></input>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="city" class="form-label">City</label>
                    <input type="text"class="form-control"id="city"placeholder="Enter your city"/>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="zipcode" class="form-label">Zip Code</label>
                    <input type="text"class="form-control" id="zipcode" placeholder="Enter your zip code" />
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-success mt-3 w-100 mt-5" onclick="addAddress()"> Save Address</button>
            </form>
          </div>
          <!-- Payment Method Section -->
            <% if (cart.total_price > 1000) { %>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="cod" disabled />
                    <label class="form-check-label" for="cod">
                        <i class="bi bi-cash"></i> Cash on Delivery <br>
                        <small>(₹1000=+ COD unavailable)</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="card" checked />
                    <label class="form-check-label" for="card">Bank Transfer</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="wallet">
                    <label class="form-check-label" for="Wallet">Wallet</label>
                </div>
            <% } else { %>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="cod" checked />
                    <label class="form-check-label" for="cod">
                        <i class="bi bi-cash"></i> Cash on Delivery
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="card" />
                    <label class="form-check-label" for="card">Online Payment</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="wallet" />
                    <label class="form-check-label" for="Wallet">Wallet</label>
                </div>
            <% } %>
          <button type="button" onclick="placeOrder()" class="btn btn-primary mt-3 w-100">
            Place Order
          </button>
        </div>
      </div>
    </div>
  </section>
    <!-- footer section -->
    <footer id="colorlib-footer" role="contentinfo">
			<div class="container">
				<div class="row row-pb-md">
					<div class="col footer-col colorlib-widget">
						<h4>About Footwear</h4>
						<p>Even the all-powerful Pointing has no control about the blind texts it is an almost
							unorthographic life</p>
						<p>
						<ul class="colorlib-social-icons">
							<li><a href="#"><i class="icon-twitter"></i></a></li>
							<li><a href="#"><i class="icon-facebook"></i></a></li>
							<li><a href="#"><i class="icon-linkedin"></i></a></li>
							<li><a href="#"><i class="icon-dribbble"></i></a></li>
						</ul>
						</p>
					</div>
					<div class="col footer-col colorlib-widget">
						<h4>Customer Care</h4>
						<p>
						<ul class="colorlib-footer-links">
							<li><a href="#">Contact</a></li>
							<li><a href="#">Returns/Exchange</a></li>
							<li><a href="#">Gift Voucher</a></li>
							<li><a href="#">Wishlist</a></li>
							<li><a href="#">Special</a></li>
							<li><a href="#">Customer Services</a></li>
							<li><a href="#">Site maps</a></li>
						</ul>
						</p>
					</div>
					<div class="col footer-col colorlib-widget">
						<h4>Information</h4>
						<p>
						<ul class="colorlib-footer-links">
							<li><a href="#">About us</a></li>
							<li><a href="#">Delivery Information</a></li>
							<li><a href="#">Privacy Policy</a></li>
							<li><a href="#">Support</a></li>
							<li><a href="#">Order Tracking</a></li>
						</ul>
						</p>
					</div>

					<div class="col footer-col">
						<h4>News</h4>
						<ul class="colorlib-footer-links">
							<li><a href="blog.html">Blog</a></li>
							<li><a href="#">Press</a></li>
							<li><a href="#">Exhibitions</a></li>
						</ul>
					</div>

					<div class="col footer-col">
						<h4>Contact Information</h4>
						<ul class="colorlib-footer-links">
							<li>291 South 21th Street, <br> Suite 721 New York NY 10016</li>
							<li><a href="tel://1234567920">+ 1235 2355 98</a></li>
							<li><a href="mailto:info@yoursite.com">info@yoursite.com</a></li>
							<li><a href="#">yoursite.com</a></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="copy">
				<div class="row">
					<div class="col-sm-12 text-center">
						<p>
							<span><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
								Copyright &copy;
								<script>document.write(new Date().getFullYear());</script> All rights reserved | This
								template is made with <i class="icon-heart" aria-hidden="true"></i> by <a
									href="https://colorlib.com" target="_blank">Colorlib</a>
								<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
							</span>
							<span class="block">Demo Images: <a href="http://unsplash.co/" target="_blank">Unsplash</a>
								, <a href="http://pexels.com/" target="_blank">Pexels.com</a></span>
						</p>
					</div>
				</div>
			</div>
		</footer>
  
    <!-- footer section -->
    <script src="/js/jquery-3.4.1.min.js"></script>
    <!-- popper js -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <!-- bootstrap js -->
    <script src="/js/bootstrap.js"></script>
    <!-- owl slider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <!-- isotope js -->
    <script src="https://unpkg.com/isotope-layout@3.0.4/dist/isotope.pkgd.min.js"></script>
    <!-- nice select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
    <!-- custom js -->
    <script src="/js/custom.js"></script>
    <!-- Google Map -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh39n5U-4IoWpsVGUHWdqB6puEkhRLdmI&callback=myMap"></script>
    <!-- End Google Map -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
      
      document.getElementById("addNewAddressBtn").addEventListener("click", function () {
        
        
          const form = document.getElementById("newAddressForm");
          form.style.display = form.style.display === "none" ? "block" : "none";
        });

      // Toggle card details display based on payment method selected
      document.getElementById("cod").addEventListener("click", function () {
        document.getElementById("card-details").style.display = "none";
      });

      document.getElementById("card").addEventListener("click", function () {
        document.getElementById("card-details").style.display = "block";
      });
    </script>
    <script>
      async function addAddress(){
        const fullName =document.getElementById('name').value.trim();
        const streetAddress =document.getElementById('address').value.trim();
        const phone =document.getElementById('phoneNumber').value.trim();
        const city =document.getElementById('city').value.trim();
        const zipCode =document.getElementById('zipcode').value.trim();
        const state =document.getElementById('state').value.trim();
        const country =document.getElementById('country').value.trim();

        const phonePattern = /^(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}$/;

        if(!fullName || !streetAddress || !phone || !city || !zipCode || !state || !country){
          Swal.fire({
              title: "Error",
              text: "All fields must be filled",
              icon: "error",
              confirmButtonText: "Okay"
          });
          return;
        }
        if(streetAddress.trim().split(/\s+/).length > 30) {
        Swal.fire({
        title: 'Error',
        text: "Only 30 words allowed",
        icon: "error",
        confirmButtonText: "Okay"
    });
    return;
       }
    if (!phonePattern.test(phone)) {
    Swal.fire({
        title: 'Error',
        text: "Invalid phone number format",
        icon: "error",
        confirmButtonText: "Okay"
    });
    return;
}
if (zipCode.length < 6 || /\s/.test(zipCode)) {
      Swal.fire({
        title:'Error',
        text:"Zipcode must be at least 6 characters and contain no spaces",
        icon:"error"
      });
      return;
    }
    try {
      const response=await fetch('/addAddress',{
      method:'POST',
      headers:{
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({fullName,streetAddress,phone,city,zipCode,state,country })
    });
    if (response.ok) {
            Swal.fire({
                title: 'Address Added!',
                text: 'The new address was added successfully.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Failed!',
                text: 'Failed to add the address. Please try again.',
            });
        }
    } catch (error) {
        console.error('Error while adding address', error);
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'An unexpected error occurred while adding the address.',
        });
    }
  }
    </script>

    <script>
      async function placeOrder() {
        console.log('place order')
    const couponCode = document.getElementById('couponCode').value.trim();
    const addressId = document.getElementById('exampleFormControlSelect1').value.trim();
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').id.trim();

    if (!addressId || !paymentMethod) {
        Swal.fire({
            title: 'Error',
            text: 'Please select an address and payment method.',
            icon: 'error'
        });
        return;
    }

    if (paymentMethod === 'cod') { 
                try {
                    const response = await fetch('/placeOrder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ addressId, paymentMethod, couponCode })
                    });

            if (response.ok) {
              const result=await response.json()
              if(result.success){
                Swal.fire({
                    title: 'Order Placed!',
                    text: 'Your order was placed successfully.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = '/orderHistory';
                });
              }else{
                Swal.fire({
                    title: 'failed  Place Order!',
                    text: result.message,
                    icon: 'error',
                    timer: 2000,
                    showConfirmButton: false
                })
              }
                
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed!',
                    text: 'Failed to place the order. Please try again.',
                });
            }
        } catch (error) {
            console.error('Error while placing order', error);
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'An unexpected error occurred while placing the order.',
            });
        }
    } else if (paymentMethod === 'card') {
console.log('card1')
    
        try {
          console.log(addressId, paymentMethod, couponCode);
            const response = await fetch('/razor-Pay-OrderCreate', {
             
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ addressId, paymentMethod, couponCode })
                
                
            });
            console.log('fetch')
            if (response.ok) {
              console.log('response')
                const result = await response.json();


                if (result.success) {
                  console.log('sucess')
                  console.log('payble amount',result.payableAmount);
                  console.log('order id',result.razorpayOrder.id);
                  
                  
                    const options = {
                        key: 'rzp_test_yn3COcw99NFgtQ', 
                        amount: result.payableAmount,
                        currency: 'INR',
                        name: 'Footwer',
                        description: 'Payment for order',
                        order_id: result.razorpayOrder.id,
                        handler: async function (response) {
                            try {
                                const response2 = await fetch('/razor-Pay-Payment', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        addressId, paymentMethod, couponCode,
                                        payment_id: response.razorpay_payment_id,
                                        order_id: response.razorpay_order_id,
                                        signature: response.razorpay_signature
                                    })
                                });

                                const verifyData = await response2.json();
                                console.log('verifyData')
                                if (response2.ok && verifyData.success) {
                                  console.log('response2.ok')
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Order Placed',
                                        text: 'Your order has been placed successfully.',
                                        timer: 2000,
                                        showConfirmButton: false
                                    }).then(() => {
                                        window.location.href = '/orderHistory';
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Payment Verification Failed',
                                        text: verifyData.error || 'Payment verification failed. Please try again.'
                                    });
                                }
                            } catch (error) {
                                console.error('Error verifying payment:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Payment Error',
                                    text: 'An unexpected error occurred during payment verification.'
                                });
                            }
                        },
                        prefill: {
                            name: 'User Name',
                            email: 'useremail@email.com',
                            contact: '112233665544'
                        },
                        theme: {
                            color: '#000000'
                        }
                    };

                    const razorpay = new Razorpay(options);

                    razorpay.on('payment.failed', async function (response) {
                        console.error('Payment Failed:', response);

                        if (response.error && response.error.metadata) {
                            try {
                                const response3 = await fetch('/razor-Pay-Payment', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        addressId,
                                        paymentMethod,
                                        couponCode,
                                        payment_id: response.error.metadata.payment_id,
                                        order_id: response.error.metadata.order_id
                                    })
                                });

                                const failedData = await response3.json();
                                const orderId = failedData.orderId;
                                
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Payment Failed',
                                    text: 'Payment was unsuccessful. Redirecting to order details...',
                                    timer: 1000,
                                    showConfirmButton: false
                                }).then(() => {
                                    if (failedData.response) {
                                        window.location.href = failedData.response;
                                    } else {
                                        window.location.href = "/orderHistory";
                                    }
                                });
                            } catch (fetchError) {
                                console.error('Error logging failed payment:', fetchError);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'An error occurred while processing payment failure.'
                                });
                            }
                        } else {
                            console.warn('Missing metadata in payment failed response');
                            Swal.fire({
                                icon: 'error',
                                title: 'Payment Error',
                                text: 'Payment failed with no additional data. Please try again.'
                            });
                        }
                    });

                    razorpay.open();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Payment Initialization Failed',
                        text: 'Could not initialize payment. Please try again.'
                    });
                }
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Order Failed',
                    text: 'Unable to place the order. Please try again later.'
                });
            }
        } catch (error) {
            console.error('Error processing order:', error);
            Swal.fire({
                icon: 'error',
                title: 'Order Error',
                text: 'An unexpected error occurred while processing the order.'
            });
        }
    }

    if (paymentMethod === 'Wallet') {
      
      console.log('Request Payload:', { addressId, paymentMethod, couponCode });
          const response = await fetch('/orderWallet', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ addressId, paymentMethod, couponCode })
          });


          if (response.ok) {
            const result = await response.json()

            if (result.success) {
              Swal.fire({
                icon: 'success',
                title: 'Order Placed',
                text: 'The order is successfully placed.',
                confirmButtonText: 'OK'
              }).then(() => {
                window.location.href = '/orderHistory';
              });

            } else {
              if (result.message === 'not enough money in your wallet') {
                Swal.fire({
                  icon: 'info',
                  title: 'insufficient money',
                  text: result.message,
                  confirmButtonText: 'OK'
                })
                return
              }


              Swal.fire({
                icon: 'error',
                title: 'Order Not Placed',
                text: result.message,
                confirmButtonText: 'OK'
              })
            }

          } else {
            Swal.fire({
              icon: 'error',
              title: 'Failed to Order',
              text: 'Unable to place order. Please try again later.',
              confirmButtonText: 'OK'
            });
          }
        }
}



</script>


<script>
  
  document.getElementById('applyCouponForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const couponCode = document.getElementById('couponCode').value;
    let originalTotal = parseFloat(document.getElementById('couponTotal').getAttribute('data-original-total'));

    
    if (!originalTotal) {
        originalTotal = parseFloat(document.getElementById('couponTotal').textContent.replace('₹', ''));
        document.getElementById('couponTotal').setAttribute('data-original-total', originalTotal);
    }

    fetch('/apply-coupon', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ couponCode }),
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('couponResult');
        const resultDiv2 = document.getElementById('couponDiscount');
        const resultDiv3 = document.getElementById('couponTotal');
        
        if (data.success) {
            resultDiv.innerHTML = `
                <p class="text-success">Coupon applied successfully!</p>
                <p id="RemoveCouponCode">Your Code: ${data.couponCode}</p>
                <p>Discount Amount: ₹${data.discountAmount}</p>
                <button onclick="removeCoupon()">Remove Coupon</button>
            `;
            resultDiv2.innerHTML = `<p>₹${data.discountAmount}.00</p>`;
            resultDiv3.innerHTML = `<p>₹${data.finalAmount}.00</p>`;
        } else {
            resultDiv.innerHTML = `<p class="text-danger">${data.message}</p>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('couponResult').innerHTML = '<p>An error occurred while applying the coupon</p>';
    });
});

function removeCoupon() {
    const couponText = document.getElementById('RemoveCouponCode').textContent;
    const couponCode = couponText.replace('Your Code: ', '').trim();

    fetch('/remove-coupon', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ couponCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const resultDiv = document.getElementById('couponResult');
            const resultDiv2 = document.getElementById('couponDiscount');
            const resultDiv3 = document.getElementById('couponTotal');

            resultDiv.innerHTML = '<p class="text-success">Coupon removed successfully</p>';
            resultDiv2.innerHTML = '<p>₹0.00</p>';

            
            const originalTotal = parseFloat(document.getElementById('couponTotal').getAttribute('data-original-total'));
            resultDiv3.innerHTML = `<p>₹${originalTotal}.00</p>`;


            document.getElementById('couponTotal').removeAttribute('data-original-total');
        } else {
            document.getElementById('couponResult').innerHTML = `<p>${data.message}</p>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('couponResult').innerHTML = '<p>An error occurred while removing the coupon</p>';
    });
}

function copyCouponCode(code) {
    navigator.clipboard.writeText(code).then(() => {
     Swal.fire({
      title:'copied',
      text:'Coupon code copied to clipboard sucess fully',
      icon: 'sucess'
     })
    }).catch(err => {
      console.error('Error copying coupon code:', err);
    });
  }

  </script>

  </body>
</html>

